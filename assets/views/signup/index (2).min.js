"use strict";exports.init=function(a,b){a.isAuthenticated()?b.redirect(a.user.defaultReturnUrl()):b.render("signup/index",{oauthMessage:"",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key})},exports.signup=function(a,b){var c=a.app.utility.workflow(a,b);c.on("validate",function(){return a.body.username?/^[a-zA-Z0-9\-\_]+$/.test(a.body.username)||(c.outcome.errfor.username="only use letters, numbers, '-', '_'"):c.outcome.errfor.username="required",a.body.email?/^[a-zA-Z0-9\-\_\.\+]+@[a-zA-Z0-9\-\_\.]+\.[a-zA-Z0-9\-\_]+$/.test(a.body.email)||(c.outcome.errfor.email="invalid email format"):c.outcome.errfor.email="required",a.body.password||(c.outcome.errfor.password="required"),c.hasErrors()?c.emit("response"):void c.emit("duplicateUsernameCheck")}),c.on("duplicateUsernameCheck",function(){a.app.db.models.User.findOne({username:a.body.username},function(a,b){return a?c.emit("exception",a):b?(c.outcome.errfor.username="username already taken",c.emit("response")):void c.emit("duplicateEmailCheck")})}),c.on("duplicateEmailCheck",function(){a.app.db.models.User.findOne({email:a.body.email.toLowerCase()},function(a,b){return a?c.emit("exception",a):b?(c.outcome.errfor.email="email already registered",c.emit("response")):void c.emit("createUser")})}),c.on("createUser",function(){a.app.db.models.User.encryptPassword(a.body.password,function(b,d){if(b)return c.emit("exception",b);var e={isActive:"yes",username:a.body.username,email:a.body.email.toLowerCase(),password:d,search:[a.body.username,a.body.email]};a.app.db.models.User.create(e,function(a,b){return a?c.emit("exception",a):(c.user=b,void c.emit("createAccount"))})})}),c.on("createAccount",function(){var b={isVerified:a.app.config.requireAccountVerification?"no":"yes","name.full":c.user.username,user:{id:c.user._id,name:c.user.username},search:[c.user.username]};a.app.db.models.Account.create(b,function(a,b){return a?c.emit("exception",a):(c.user.roles.account=b._id,void c.user.save(function(a){return a?c.emit("exception",a):void c.emit("sendWelcomeEmail")}))})}),c.on("sendWelcomeEmail",function(){a.app.utility.sendmail(a,b,{from:a.app.config.smtp.from.name+" <"+a.app.config.smtp.from.address+">",to:a.body.email,subject:"Your "+a.app.config.projectName+" Account",textPath:"signup/email-text",htmlPath:"signup/email-html",locals:{username:a.body.username,email:a.body.email,loginURL:a.protocol+"://"+a.headers.host+"/login/",projectName:a.app.config.projectName},success:function(){c.emit("logUserIn")},error:function(a){console.log("Error Sending Welcome Email: "+a),c.emit("logUserIn")}})}),c.on("logUserIn",function(){a._passport.instance.authenticate("local",function(b,d){return b?c.emit("exception",b):d?void a.login(d,function(a){return a?c.emit("exception",a):(c.outcome.defaultReturnUrl=d.defaultReturnUrl(),void c.emit("response"))}):(c.outcome.errors.push("Login failed. That is strange."),c.emit("response"))})(a,b)}),c.emit("validate")},exports.signupTwitter=function(a,b,c){a._passport.instance.authenticate("twitter",function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"twitter.id":f.profile.id},function(d,e){return d?c(d):void(e?b.render("signup/index",{oauthMessage:"We found a user linked to your Twitter account.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}):(a.session.socialProfile=f.profile,b.render("signup/social",{email:""})))}):b.redirect("/signup/")})(a,b,c)},exports.signupGitHub=function(a,b,c){a._passport.instance.authenticate("github",function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"github.id":f.profile.id},function(d,e){return d?c(d):void(e?b.render("signup/index",{oauthMessage:"We found a user linked to your GitHub account.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}):(a.session.socialProfile=f.profile,b.render("signup/social",{email:f.profile.emails&&f.profile.emails[0].value||""})))}):b.redirect("/signup/")})(a,b,c)},exports.signupFacebook=function(a,b,c){a._passport.instance.authenticate("facebook",{callbackURL:"/signup/facebook/callback/"},function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"facebook.id":f.profile.id},function(d,e){return d?c(d):void(e?b.render("signup/index",{oauthMessage:"We found a user linked to your Facebook account.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}):(a.session.socialProfile=f.profile,b.render("signup/social",{email:f.profile.emails&&f.profile.emails[0].value||""})))}):b.redirect("/signup/")})(a,b,c)},exports.signupGoogle=function(a,b,c){a._passport.instance.authenticate("google",{callbackURL:"/signup/google/callback/"},function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"google.id":f.profile.id},function(d,e){return d?c(d):void(e?b.render("signup/index",{oauthMessage:"We found a user linked to your Google account.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}):(a.session.socialProfile=f.profile,b.render("signup/social",{email:f.profile.emails&&f.profile.emails[0].value||""})))}):b.redirect("/signup/")})(a,b,c)},exports.signupTumblr=function(a,b,c){a._passport.instance.authenticate("tumblr",{callbackURL:"/signup/tumblr/callback/"},function(d,e,f){return f&&f.profile?(f.profile.hasOwnProperty("id")||(f.profile.id=f.profile.username),void a.app.db.models.User.findOne({"tumblr.id":f.profile.id},function(d,e){return d?c(d):void(e?b.render("signup/index",{oauthMessage:"We found a user linked to your Tumblr account.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}):(a.session.socialProfile=f.profile,b.render("signup/social",{email:f.profile.emails&&f.profile.emails[0].value||""})))})):b.redirect("/signup/")})(a,b,c)},exports.signupSocial=function(a,b){var c=a.app.utility.workflow(a,b);c.on("validate",function(){return a.body.email?/^[a-zA-Z0-9\-\_\.\+]+@[a-zA-Z0-9\-\_\.]+\.[a-zA-Z0-9\-\_]+$/.test(a.body.email)||(c.outcome.errfor.email="invalid email format"):c.outcome.errfor.email="required",c.hasErrors()?c.emit("response"):void c.emit("duplicateUsernameCheck")}),c.on("duplicateUsernameCheck",function(){c.username=a.session.socialProfile.username||a.session.socialProfile.id,/^[a-zA-Z0-9\-\_]+$/.test(c.username)||(c.username=c.username.replace(/[^a-zA-Z0-9\-\_]/g,"")),a.app.db.models.User.findOne({username:c.username},function(b,d){return b?c.emit("exception",b):(c.username=d?c.username+a.session.socialProfile.id:c.username,void c.emit("duplicateEmailCheck"))})}),c.on("duplicateEmailCheck",function(){a.app.db.models.User.findOne({email:a.body.email.toLowerCase()},function(a,b){return a?c.emit("exception",a):b?(c.outcome.errfor.email="email already registered",c.emit("response")):void c.emit("createUser")})}),c.on("createUser",function(){var b={isActive:"yes",username:c.username,email:a.body.email.toLowerCase(),search:[c.username,a.body.email]};b[a.session.socialProfile.provider]={id:a.session.socialProfile.id},a.app.db.models.User.create(b,function(a,b){return a?c.emit("exception",a):(c.user=b,void c.emit("createAccount"))})}),c.on("createAccount",function(){var b=a.session.socialProfile.displayName||"",d=b.split(" "),e={isVerified:"yes","name.first":d[0],"name.last":d[1]||"","name.full":b,user:{id:c.user._id,name:c.user.username},search:[d[0],d[1]||""]};a.app.db.models.Account.create(e,function(a,b){return a?c.emit("exception",a):(c.user.roles.account=b._id,void c.user.save(function(a){return a?c.emit("exception",a):void c.emit("sendWelcomeEmail")}))})}),c.on("sendWelcomeEmail",function(){a.app.utility.sendmail(a,b,{from:a.app.config.smtp.from.name+" <"+a.app.config.smtp.from.address+">",to:a.body.email,subject:"Your "+a.app.config.projectName+" Account",textPath:"signup/email-text",htmlPath:"signup/email-html",locals:{username:c.user.username,email:a.body.email,loginURL:a.protocol+"://"+a.headers.host+"/login/",projectName:a.app.config.projectName},success:function(){c.emit("logUserIn")},error:function(a){console.log("Error Sending Welcome Email: "+a),c.emit("logUserIn")}})}),c.on("logUserIn",function(){a.login(c.user,function(b){return b?c.emit("exception",b):(delete a.session.socialProfile,c.outcome.defaultReturnUrl=c.user.defaultReturnUrl(),void c.emit("response"))})}),c.emit("validate")};
//# sourceMappingURL=index%20(2).min.js.map