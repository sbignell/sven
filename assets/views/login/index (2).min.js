"use strict";var getReturnUrl=function(a){var b=a.user.defaultReturnUrl();return a.session.returnUrl&&(b=a.session.returnUrl,delete a.session.returnUrl),b};exports.init=function(a,b){a.isAuthenticated()?b.redirect(getReturnUrl(a)):b.render("login/index",{oauthMessage:"",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key})},exports.login=function(a,b){var c=a.app.utility.workflow(a,b);c.on("validate",function(){return a.body.username||(c.outcome.errfor.username="required"),a.body.password||(c.outcome.errfor.password="required"),c.hasErrors()?c.emit("response"):void c.emit("abuseFilter")}),c.on("abuseFilter",function(){var b=function(b){var c={ip:a.ip};a.app.db.models.LoginAttempt.count(c,function(a,c){return a?b(a):void b(null,c)})},d=function(b){var c={ip:a.ip,user:a.body.username};a.app.db.models.LoginAttempt.count(c,function(a,c){return a?b(a):void b(null,c)})},e=function(b,d){return b?c.emit("exception",b):d.ip>=a.app.config.loginAttempts.forIp||d.ipUser>=a.app.config.loginAttempts.forIpAndUser?(c.outcome.errors.push("You've reached the maximum number of login attempts. Please try again later."),c.emit("response")):void c.emit("attemptLogin")};require("async").parallel({ip:b,ipUser:d},e)}),c.on("attemptLogin",function(){a._passport.instance.authenticate("local",function(b,d){if(b)return c.emit("exception",b);if(d)a.login(d,function(a){return a?c.emit("exception",a):void c.emit("response")});else{var e={ip:a.ip,user:a.body.username};a.app.db.models.LoginAttempt.create(e,function(a){return a?c.emit("exception",a):(c.outcome.errors.push("Username and password combination not found or your account is inactive."),c.emit("response"))})}})(a,b)}),c.emit("validate")},exports.loginTwitter=function(a,b,c){a._passport.instance.authenticate("twitter",function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"twitter.id":f.profile.id},function(d,e){return d?c(d):void(e?a.login(e,function(d){return d?c(d):void b.redirect(getReturnUrl(a))}):b.render("login/index",{oauthMessage:"No users found linked to your Twitter account. You may need to create an account first.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}))}):b.redirect("/login/")})(a,b,c)},exports.loginGitHub=function(a,b,c){a._passport.instance.authenticate("github",function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"github.id":f.profile.id},function(d,e){return d?c(d):void(e?a.login(e,function(d){return d?c(d):void b.redirect(getReturnUrl(a))}):b.render("login/index",{oauthMessage:"No users found linked to your GitHub account. You may need to create an account first.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}))}):b.redirect("/login/")})(a,b,c)},exports.loginFacebook=function(a,b,c){a._passport.instance.authenticate("facebook",{callbackURL:"/login/facebook/callback/"},function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"facebook.id":f.profile.id},function(d,e){return d?c(d):void(e?a.login(e,function(d){return d?c(d):void b.redirect(getReturnUrl(a))}):b.render("login/index",{oauthMessage:"No users found linked to your Facebook account. You may need to create an account first.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}))}):b.redirect("/login/")})(a,b,c)},exports.loginGoogle=function(a,b,c){a._passport.instance.authenticate("google",{callbackURL:"/login/google/callback/"},function(d,e,f){return f&&f.profile?void a.app.db.models.User.findOne({"google.id":f.profile.id},function(d,e){return d?c(d):void(e?a.login(e,function(d){return d?c(d):void b.redirect(getReturnUrl(a))}):b.render("login/index",{oauthMessage:"No users found linked to your Google account. You may need to create an account first.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}))}):b.redirect("/login/")})(a,b,c)},exports.loginTumblr=function(a,b,c){a._passport.instance.authenticate("tumblr",{callbackURL:"/login/tumblr/callback/"},function(d,e,f){return f&&f.profile?(f.profile.hasOwnProperty("id")||(f.profile.id=f.profile.username),void a.app.db.models.User.findOne({"tumblr.id":f.profile.id},function(d,e){return d?c(d):void(e?a.login(e,function(d){return d?c(d):void b.redirect(getReturnUrl(a))}):b.render("login/index",{oauthMessage:"No users found linked to your Tumblr account. You may need to create an account first.",oauthTwitter:!!a.app.config.oauth.twitter.key,oauthGitHub:!!a.app.config.oauth.github.key,oauthFacebook:!!a.app.config.oauth.facebook.key,oauthGoogle:!!a.app.config.oauth.google.key,oauthTumblr:!!a.app.config.oauth.tumblr.key}))})):b.redirect("/login/")})(a,b,c)};
//# sourceMappingURL=index%20(2).min.js.map