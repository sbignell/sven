!function(){"use strict";app=app||{},app.clearForm=function(a){console.log("clear the form: "+a);for(var b=0;b<a.length;b++){var c=a[b].type.toLowerCase();switch(c){case"text":case"password":case"textarea":case"hidden":a[b].value="";break;case"radio":case"checkbox":a[b].checked&&(a[b].checked=!1);break;case"select-one":case"select-multi":a[b].selectedIndex=-1}}},app.finishSignIn=function(){"undefined"==typeof app.views.mycellarView&&(console.log("creating mycellarView"),app.views.mycellarView=new app.MyCellarView),console.log("finishSignIn"),$(".form-control").attr("disabled",!1),$("#doSignIn").attr("disabled",!1),$("#doSignUp").attr("disabled",!1),$("#signinupDropdown").attr("disabled",!1),$(".dropdown-menu").attr("disabled",!1),$("#signStatus").css("display","none");var a='<button id="signedinDropdown" class="btn btn-success dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="true">';a+='<span class="fa fa-user"></span> '+app.user.attributes.username+' <span class="caret"></span></button>',a+='<ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="signedinDropdown">',a+='<li><a id="bprofile" href="#">Profile</a></li>',-1!=app.user.attributes.roles.indexOf("0,")&&(a+='<li><a id="badmin" href="#">Administer</a></li>'),a+='<li><a id="signout" href="http://www.sidandsven.com/logout/">Sign Out</a></li>',a+="</ul>",$("div.dropdown").html(a),$(".dropdown-toggle").dropdown("toggle"),app.showView(app.views.cellarView)},app.getUrlParameter=function(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}},app.showView=function(a){console.log("showView: "),console.dir(a.el),a!=app.views.resetView&&("undefined"!=typeof app.getUrlParameter("u")?window.history.replaceState({},"Sid is awake.","http://www.sidandsven.com"):"undefined"!=typeof app.getUrlParameter("t")&&window.history.replaceState({},"Sid is awake.","http://www.sidandsven.com")),a==app.views.cellarView&&"undefined"!=typeof app.user&&""!=app.user.attributes.username&&(console.log("showView: user logged in and requested cellarView"),a=app.views.mycellarView),void 0!=app.views.current&&$(app.views.current.el).hide(),app.views.current=a,$(app.views.current.el).show()},app.Login=Backbone.Model.extend({url:"/api/v1/login/",defaults:{errors:[],errfor:{},username:"",password:""}}),app.Signup=Backbone.Model.extend({url:"/api/v1/signup/",defaults:{errors:[],errfor:{},username:"",email:"",password:"",roles:""}}),app.User=Backbone.Model.extend({url:"/api/v1/user/",defaults:{errors:[],errfor:{},id:"",username:"",email:"",firstname:"",lastname:"",isActive:"",isVerified:"",roles:"",groups:"",phone:"",twitterKey:"",facebookKey:"",googleKey:"",githubKey:"",createdById:""}}),app.Record=Backbone.Model.extend({defaults:{id:void 0,grape:"",estate:"",name:"",notes:"",rating:"",createdById:""},url:function(){return"/api/v1/cellar/"+(this.isNew()?"":this.id+"/")}}),app.RecordCollection=Backbone.Collection.extend({model:app.Record,url:"/api/v1/cellar/"}),app.UserRecord=Backbone.Model.extend({defaults:{id:void 0,username:"",email:"",firstname:"",lastname:"",isActive:"",isVerified:"",roles:"",groups:"",phone:"",twitterKey:"",facebookKey:"",googleKey:"",githubKey:"",createdById:""},url:function(){return"/api/v1/admin/users/"+(this.isNew()?"":this.id+"/")}}),app.UserCollection=Backbone.Collection.extend({model:app.UserRecord,url:"/api/v1/admin/users/"}),app.HeaderView=Backbone.View.extend({el:"#header",template:_.template(JST["assets/views/header/tmpl-header.html"]()),events:{"click #gotoHome":"processHome","click #gotoAbout":"processAbout","click #gotoCellar":"processCellar","click #doSignIn":"doSignIn","click #doSignUp":"doSignUp","click #doCancelSignUp":"doCancelSignUp","click #social-signup-buttons a":"doSocialSignUp","click #gotoForgot":"processForgot","click #gotoReset":"processReset","click #bprofile":"showProfile","click #badmin":"showAdmin"},initialize:function(){console.log("headerView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this},processHome:function(a){a.preventDefault(),console.log("view: #gotoHome clicked"),$("#public-menu").children().removeClass("active"),app.showView(app.views.homeView)},processAbout:function(a){a.preventDefault(),console.log("view: #gotoAbout clicked"),$("#public-menu > li.active").removeClass("active"),app.showView(app.views.aboutView),$("#gotoAbout").parent().addClass("active")},processCellar:function(a){a.preventDefault(),console.log("view: #gotoCellar clicked"),$("#public-menu > li.active").removeClass("active"),app.showView(app.views.cellarView),$("#gotoCellar").parent().addClass("active")},doSignIn:function(a){a.preventDefault(),console.log("view: #doSignIn clicked"),$("#signStatus").css("display","inline"),$("#signAlert").html(""),$("#signinupDropdown").attr("disabled",!0),$(".dropdown-menu").attr("disabled",!0),$(".form-control").attr("disabled",!0),$("#doSignIn").attr("disabled",!0),$("#doSignUp").attr("disabled",!0),app.login=new app.Login,app.login.save({username:$("#inputUsername").val(),password:$("#inputPassword").val()},{success:function(a,b){if(b.success)console.log("Signed In!"),app.user.attributes.username=b.username,app.user.attributes.id=b.userid,app.user.attributes.roles=b.roles,app.user.attributes.firstname=b.firstname,app.user.attributes.lastname=b.lastname,app.user.attributes.isActive=b.isActive,app.user.attributes.isVerified=b.isVerified,app.user.attributes.groups=b.groups,app.user.attributes.phone=b.phone,app.user.attributes.twitterKey=b.twitterKey,app.user.attributes.facebookKey=b.facebookKey,app.user.attributes.googleKey=b.googleKey,app.user.attributes.githubKey=b.githubKey,app.user.attributes.createdById=b.createdById,app.finishSignIn();else{a.set(b);var c='<div class="alert alert-danger" role="alert">'+b.errors+"</div>";console.log("Fail!"),$(".form-control").attr("disabled",!1),$("#doSignIn").attr("disabled",!1),$("#doSignUp").attr("disabled",!1),$("#signinupDropdown").attr("disabled",!1),$(".dropdown-menu").attr("disabled",!1),$("#signStatus").css("display","none"),$("#signAlert").html(c)}}})},doSignUp:function(a){a.preventDefault(),console.log("view: #doSignUp clicked"),$("#signStatus").css("display","inline"),$("#signAlert").html(""),$("#signinupDropdown").attr("disabled",!0),$(".dropdown-menu").attr("disabled",!0),$(".form-control").attr("disabled",!0),$("#doSignIn").attr("disabled",!0),$("#inputEmail").attr("disabled",!0),$("#doSignUp").attr("disabled",!0),$("#doCancelSignUp").attr("disabled",!0),app.signup=new app.Signup,app.signup.save({username:$("#inputUsername").val(),password:$("#inputPassword").val(),email:$("#inputEmail").val(),roles:"1,"},{success:function(a,b){if(b.success)console.log("Signed Up!!!"),app.user=new app.User,app.user.attributes.username=b.username,app.user.attributes.id=b.userid,app.user.attributes.roles=b.roles,app.user.attributes.firstname=b.firstname,app.user.attributes.lastname=b.lastname,app.finishSignIn();else{a.set(b);var c='<div class="alert alert-danger" role="alert">'+b.errors+"</div>";console.log("Fail!"),$(".form-control").attr("disabled",!1),$("#doSignIn").attr("disabled",!1),$("#doSignUp").attr("disabled",!1),$("#signinupDropdown").attr("disabled",!1),$(".dropdown-menu").attr("disabled",!1),$("#signStatus").css("display","none"),$("#signAlert").html(c)}}})},doCancelSignUp:function(a){console.log("signup cancelled"),$(".form-control").attr("disabled",!1),$("#doSignIn").attr("disabled",!1),$("#doSignUp").attr("disabled",!1),$("#signinupDropdown").attr("disabled",!1),$(".dropdown-menu").attr("disabled",!1),$("#signStatus").css("display","none"),$(".dropdown-toggle").dropdown("toggle")},processForgot:function(a){a.preventDefault(),console.log("view: #gotoForgot clicked"),$("#public-menu").children().removeClass("active"),app.showView(app.views.forgotView)},processReset:function(a){a.preventDefault(),console.log("view: #gotoReset clicked"),$("#public-menu").children().removeClass("active"),app.showView(app.views.resetView)},showProfile:function(a){console.log("view: #bprofile clicked"),console.dir(app.views.profileView),$("#public-menu").children().removeClass("active"),app.showView(app.views.profileView)},showAdmin:function(a){console.log("view: #badmin clicked"),console.dir(app.views.adminView),$("#public-menu").children().removeClass("active"),app.showView(app.views.adminView)}}),app.HomeView=Backbone.View.extend({el:"#home",template:_.template(JST["assets/views/home/tmpl-home.html"]()),initialize:function(){console.log("homeView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this}}),app.AboutView=Backbone.View.extend({el:"#about",template:_.template(JST["assets/views/about/tmpl-about.html"]()),initialize:function(){console.log("aboutView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this}}),app.CellarView=Backbone.View.extend({el:"#cellar",template:_.template(JST["assets/views/cellar/tmpl-cellar.html"]()),initialize:function(){console.log("cellarView loaded."),this.render()},render:function(){return console.log("cellarView: render"),this.$el.html(this.template("hello")),this}}),app.MyCellarView=Backbone.View.extend({el:"#cellar",template:_.template(JST["assets/views/cellar/tmpl-cellar.html"]()),events:{"click #submit-wine":"submitWine","click #cancel-wine":"cancelWine","click .delete-wine":"deleteWine"},initialize:function(){console.log("mycellarView loaded.");var a=this;this.collection=new app.RecordCollection,this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.collection.fetch({success:function(b,c,d){console.dir(b),console.dir(c),app.views.profileView=new app.ProfileView,"undefined"==typeof app.views.adminView&&-1!=app.user.attributes.roles.indexOf("0,")&&(app.views.adminView=new app.AdminView),a.render()}})},render:function(){console.log("mycellarView: render"),console.log(this.collection.length),this.$el.html(this.template()),$("#cellar .btn-group").append('<button id="add-wine" class="btn btn-default btn-sm" data-toggle="modal" data-target="#wine-modal" data-backdrop="false"><span class="fa fa-plus"></span></button>'),$("#cellar .table thead tr").prepend('<th><span class="fa fa-trash-o"></span></th>'),$("#results-rows").empty(),0==this.collection.length&&(console.log("We need to add the dummy item"),$("#results-rows").append("<tr><td>Chardonnay</td><td>Heemskerk</td><td>2012 Coal River Valley Chardonnay</td><td>Bright straw-green; French oak barrel fermented, and pure class from start to finish, with perfect balance, line and length; Tasmanian acidity provides the framework and the length of a delicious wine. Trophy Best Chardonnay Tasmanian Wine Show ’14.</td><td>9.8</td></tr>"));var a="Welcome, "+app.user.attributes.username,b="This is your wine cellar, why don't you start adding your favourite drops! Look, I've started you off with one of my personal favourites.",c="Excellent, I see you have great taste in wine! Keep building your cellar!",d="This is quite the collection you have! You'll need to stop there or you risk overshadowing me!!",e='<img class="wines" src="media/wines.png" /> '+app.user.attributes.username+"'s Top 20";$("#cellar div.media-body h4.media-heading").html(a),0==this.collection.length?$("#cellar div.media-body p.cellarConversation").text(b):this.collection.length<20?$("#cellar div.media-body p.cellarConversation").text(c):20==this.collection.length&&$("#cellar div.media-body p.cellarConversation").text(d),$("#cellar div.panel-heading h3.panel-title").html(e);var f=document.createDocumentFragment();return console.log("reached wine record creation"),this.collection.each(function(a){console.log("Wine name is: "+a.attributes.name);var b=new app.ResultsRowView({model:a});f.appendChild(b.render().el)},this),$("#results-rows").append(f),this},addWine:function(a){a.preventDefault(),console.log("add wine"),$("#wine-modal").modal("show")},submitWine:function(a){console.log("submit wine");var b=this,c=new app.Record;c.save({grape:this.$el.find(".modal #wineGrape").val(),estate:this.$el.find(".modal #wineEstate").val(),name:this.$el.find(".modal #wineName").val(),notes:this.$el.find(".modal #wineNotes").val(),rating:this.$el.find(".modal #wineRating").val(),createdById:app.user.attributes.id,createdByName:app.user.attributes.username},{success:function(a,c){console.log("success"),$("#wine-modal").modal("hide"),b.collection.add(a)},error:function(a,b){console.log("error")}})},cancelWine:function(a){console.log("cancel wine"),$("#wine-modal").modal("hide")},deleteWine:function(a){console.log("delete wine"),console.dir($(a.currentTarget).closest("tr"));var b=this,c=$(a.currentTarget).closest("tr").children();console.log("wineName: "),console.dir(c[3]);var d=this.collection.findWhere({name:c[3].innerText});console.log("removeWine: "),console.dir(d),d.destroy().complete(function(){b.collection.fetch()})}}),app.ForgotView=Backbone.View.extend({el:"#forgot",template:_.template(JST["assets/views/login/forgot/tmpl-forgot.html"]()),events:{"click #doForgot":"doForgot"},initialize:function(){console.log("forgotView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this},doForgot:function(a){a.preventDefault(),console.log("view: #doForgot clicked");var b={};b.email=$("#forgotEmail").val(),$.post("api/v1/login/forgot/",b,function(a,b){console.log("responded:"),console.dir(a);var c="";a.success?(c='<div class="alert alert-success" role="alert">Success! Check your email.</div>',$("#forgotErrors").html(c)):(c='<div class="alert alert-danger" role="alert">'+a.errors+"</div>",$("#forgotErrors").html(c))})}}),app.ResetView=Backbone.View.extend({el:"#reset",template:_.template(JST["assets/views/login/reset/tmpl-reset.html"]()),events:{"click #doReset":"doReset"},initialize:function(){console.log("resetView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this},doReset:function(a){a.preventDefault(),console.log("view: #doReset clicked");var b={};b.password=$("#resetPassword").val(),b.confirm=$("#resetConfirm").val(),$.ajax({url:"api/v1/login/reset/"+app.getUrlParameter("u")+"/"+app.getUrlParameter("t")+"/",data:b,type:"PUT",success:function(a){console.log("response:"),console.dir(a);var b="";a.success?(b='<div class="alert alert-success" role="alert">Success! Move along now. <a href="http://www.sidandsven.com">Click here</a> to go back!</div>',$("#resetErrors").html(b)):(b='<div class="alert alert-danger" role="alert">'+a.errors+"</div>",$("#resetErrors").html(b))}})}}),app.ResultsRowView=Backbone.View.extend({tagName:"tr",events:{},viewDetails:function(){location.href=this.model.url()},render:function(){return console.log("ResultsRowView: render"),console.dir(this.model.attributes),this.$el.html(_.template(JST["assets/views/cellar/wines/tmpl-wines.html"](this.model))),this}}),app.ProfileView=Backbone.View.extend({el:"#profile",events:{"click #profile-settings":"doProfileSettings","click #submit-profile":"doSubmitProfileChanges"},initialize:function(){console.log("profileView loaded.");var a=app.views.mycellarView.collection;console.log(a.length);var b=a.length,c=0;a.length>0?a.each(function(a){console.log(a.attributes.rating),c+=parseInt(a.attributes.rating)}):c=0;var d={avgRating:c,noWines:b};this.render(d)},render:function(a){console.log("ProfileView: render");var b=app.views.mycellarView.collection;return b.length>0?a.avgRating=(a.avgRating/a.noWines).toFixed(2):a.avgRating=0,this.$el.html(_.template(JST["assets/views/profile/tmpl-profile.html"](a))),this},doProfileSettings:function(a){app.clearForm($("#profile-settings-modal form input"));var b=app.user;$("#profileUsername").val(b.attributes.username),$("#profileEmail").val(b.attributes.email),$("#profileFirst").val(b.attributes.firstname),$("#profileLast").val(b.attributes.lastname),$("#profilePhone").val(b.attributes.phone),$("#profileTwitter").val(b.attributes.twitterKey),$("#profileFacebook").val(b.attributes.facebookKey),$("#profileGoogle").val(b.attributes.googleKey),$("#profileGithub").val(b.attributes.githubKey)},doSubmitProfileChanges:function(){console.log("submitted profile changes");var a=this,b="";$("#profileGroups").find(":selected").each(function(){b=b+$(this).text()+", "}),app.user.save({firstname:$("#profileFirst").val(),lastname:$("#profileLast").val(),groups:b,phone:$("#profilePhone").val(),twitterKey:$("#profileTwitter").val(),facebookKey:$("#profileFacebook").val(),googleKey:$("#profileGoogle").val(),githubKey:$("#profileGithub").val()}).then(function(){a.render}),$("#profile-settings-modal").hide()}}),app.AdminView=Backbone.View.extend({el:"#admin",template:_.template(JST["assets/views/admin/tmpl-admin.html"]()),events:{"click .delete-user":"doDeleteUser","click #submit-add-user":"doAddUser","click #loadEditModal":"loadEditUser","click #submit-edit-user":"submitEditUser"},initialize:function(){console.log("adminView loaded.");var a=this;this.collection=new app.UserCollection,this.collection.fetch({success:function(b,c,d){console.log("users retrieved"),console.dir(b),console.dir(c),a.render()}})},render:function(){console.log("AdminView: render");var a=0;$.ajax({url:"/api/v1/admin/totalwines/"}).done(function(a){$("#no-wines").html(a)}),this.$el.html(this.template()),$("#manage-users-table .btn-group").append('<button id="add-user" class="btn btn-default btn-sm" data-toggle="modal" data-target="#add-user-modal" data-backdrop="false"><span class="fa fa-plus"></span></button>'),$("#manage-users-table .table thead tr").prepend('<th><span class="fa fa-trash-o"></span></th>');var b=document.createDocumentFragment();return this.collection.each(function(c){c.attributes.roles=c.attributes.roles.replace("0","admin"),c.attributes.roles=c.attributes.roles.replace("1","user");var d=new app.AdminResultsRowView({model:c});b.appendChild(d.render().el),c.attributes.roles.search("admin")+1&&(a+=1)},this),$("#admin-results-rows").append(b),$("#no-users").html(this.collection.length),$("#no-admins").html(a),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this},doDeleteUser:function(a){var b=$(a.currentTarget).closest("tr").children();console.log("username: "),console.dir(b[2]);var c=this.collection.findWhere({username:b[2].innerText});console.log("removeUser: "),console.dir(c),c.destroy().complete(function(){self.collection.fetch()})},doAddUser:function(){var a=this,b=new app.UserRecord;b.save({username:this.$el.find("#add-user-modal #userUsername").val(),email:this.$el.find("#add-user-modal #userEmail").val(),roles:"1,",createdById:app.user.attributes.id},{success:function(b,c){console.log("success"),$("#add-user-modal").modal("hide"),a.collection.add(b),a.collection.fetch()},error:function(a,b){console.log("error")}})},loadEditUser:function(a){console.log("loading edit user data"),app.clearForm($("#edit-user-modal form input"));var b=$(a.currentTarget).closest("tr").children(),c=this.collection.findWhere({username:b[2].innerText});console.dir(c);var d=c.attributes.roles.indexOf("admin,"),e=c.attributes.roles.indexOf("user,");$("#editUsername").val(c.attributes.username),$("#editEmail").val(c.attributes.email),$("#editFirst").val(c.attributes.firstname),$("#editLast").val(c.attributes.lastname),"yes"==c.attributes.isActive?$("#activeRadios #optionsRadios1").prop("checked",!0):$("#activeRadios #optionsRadios2").prop("checked",!0),"yes"==c.attributes.isVerified?$("#verifiedRadios #optionsRadios1").prop("checked",!0):$("#verifiedRadios #optionsRadios2").prop("checked",!0),-1!=d&&$("#editRolesAdmin .admin").prop("checked",!0),-1!=e&&$("#editRolesUser .user").prop("checked",!0),$("#editPhone").val(c.attributes.phone),$("#editTwitter").val(c.attributes.twitterKey),$("#editFacebook").val(c.attributes.facebookKey),$("#editGoogle").val(c.attributes.googleKey),$("#editGithub").val(c.attributes.githubKey)},submitEditUser:function(){console.log("edit user submitted");var a=this,b="no",c="no",d="",e="",f=this.collection.findWhere({username:$("#editUsername").val()});b=$("input[name=activeRadios]:checked").val(),c=$("input[name=verifiedRadios]:checked").val(),$(".checkbox input:checked").each(function(){d=d+$(this).val()+", "}),$("#editGroups").find(":selected").each(function(){e=e+$(this).text()+", "}),f.save({firstname:$("#editFirst").val(),lastname:$("#editLast").val(),isActive:b,isVerified:c,roles:d,groups:e,phone:$("#editPhone").val(),twitterKey:$("#editTwitter").val(),facebookKey:$("#editFacebook").val(),googleKey:$("#editGoogle").val(),githubKey:$("#editGithub").val()}).then(function(){a.render}),$("#edit-user-modal").hide()}}),app.AdminResultsRowView=Backbone.View.extend({tagName:"tr",viewDetails:function(){},render:function(){return this.$el.html(_.template(JST["assets/views/admin/users/tmpl-a-users.html"](this.model))),"root"==this.model.attributes.username&&(console.log("row user is root"),console.dir(this.$(".delete-user").html()),this.$(".delete-user").remove()),this}}),window.onload=function(){console.log("app loading..."),app.firstLoad=!0,app.user=new app.User,app.user.fetch({success:function(a,b,c){console.log("fetched user"),console.dir(a),console.dir(b),void 0!=a.attributes.username&&""!=a.attributes.username&&app.finishSignIn()}}),app.views={},app.views.headerView=new app.HeaderView,app.views.homeView=new app.HomeView,app.views.current=app.views.homeView,app.views.aboutView=new app.AboutView,app.views.cellarView=new app.CellarView,app.views.forgotView=new app.ForgotView,app.views.resetView=new app.ResetView,console.log("app loaded!"),console.log(app.getUrlParameter("u")),console.log(app.getUrlParameter("t")),"undefined"!=typeof app.getUrlParameter("u")&&"undefined"!=typeof app.getUrlParameter("t")&&app.showView(app.views.resetView)}}();