!function(){"use strict";app=app||{},app.getUrlParameter=function(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}},app.showView=function(a){console.log("showView: "),console.dir(a.el),a!=app.views.resetView&&("undefined"!=typeof app.getUrlParameter("u")?window.history.replaceState({},"Simon is awake.","http://www.revisit.cc"):"undefined"!=typeof app.getUrlParameter("t")&&window.history.replaceState({},"Simon is awake.","http://www.revisit.cc")),a==app.views.cellarView&&"undefined"!=typeof app.user&&(console.log("showView: user logged in and requested cellarView"),"undefined"==typeof app.views.mycellarView&&(console.log("showView: creating mycellarView"),app.views.mycellarView=new app.MyCellarView),a=app.views.mycellarView),void 0!=app.views.current&&$(app.views.current.el).hide(),app.views.current=a,$(app.views.current.el).show()},app.Login=Backbone.Model.extend({url:"/api/v1/login/",defaults:{errors:[],errfor:{},username:"",password:""}}),app.Signup=Backbone.Model.extend({url:"/api/v1/signup/",defaults:{errors:[],errfor:{},username:"",email:"",password:""}}),app.User=Backbone.Model.extend({url:"/api/v1/user/",defaults:{errors:[],errfor:{},username:"",email:""}}),app.Record=Backbone.Model.extend({idAttribute:"_id",defaults:{_id:void 0,"name.full":"",company:"",phone:"",zip:"",status:{id:void 0,name:"",userCreated:{}},userCreated:{}},url:function(){return"/admin/accounts/"+(this.isNew()?"":this.id+"/")}}),app.RecordCollection=Backbone.Collection.extend({model:app.Record,url:"/admin/accounts/",parse:function(a){return app.pagingView.model.set({pages:a.pages,items:a.items}),app.filterView.model.set(a.filters),a.data}}),app.Filter=Backbone.Model.extend({defaults:{search:"",status:"",sort:"",limit:""}}),app.Paging=Backbone.Model.extend({defaults:{pages:{},items:{}}}),app.HeaderView=Backbone.View.extend({el:"#header",template:_.template(JST["assets/views/header/tmpl-header.html"]()),events:{"click #gotoHome":"processHome","click #gotoAbout":"processAbout","click #gotoCellar":"processCellar","click #doSignIn":"doSignIn","click #doSignUp":"doSignUp","click #gotoForgot":"processForgot","click #gotoReset":"processReset"},initialize:function(){console.log("headerView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this},processHome:function(a){a.preventDefault(),console.log("view: #gotoHome clicked"),$("#public-menu").children().removeClass("active"),app.showView(app.views.homeView)},processAbout:function(a){a.preventDefault(),console.log("view: #gotoAbout clicked"),$("#public-menu > li.active").removeClass("active"),app.showView(app.views.aboutView),$("#gotoAbout").parent().addClass("active")},processCellar:function(a){a.preventDefault(),console.log("view: #gotoCellar clicked"),$("#public-menu > li.active").removeClass("active"),app.showView(app.views.cellarView),$("#gotoCellar").parent().addClass("active")},doSignIn:function(a){a.preventDefault(),console.log("view: #doSignIn clicked"),$("#signStatus").css("display","inline"),$("#signAlert").html(""),$("#signinupDropdown").attr("disabled",!0),$(".dropdown-menu").attr("disabled",!0),$(".form-control").attr("disabled",!0),$("#doSignIn").attr("disabled",!0),$("#doSignUp").attr("disabled",!0),app.login=new app.Login,app.login.save({username:$("#inputUsername").val(),password:$("#inputPassword").val()},{success:function(a,b){if(b.success){console.log("Signed In!"),console.dir(a),console.dir(b),app.user=new app.User({username:a.attributes.username}),$(".form-control").attr("disabled",!1),$("#doSignIn").attr("disabled",!1),$("#doSignUp").attr("disabled",!1),$("#signinupDropdown").attr("disabled",!1),$(".dropdown-menu").attr("disabled",!1),$("#signStatus").css("display","none");var c='<button id="signedinDropdown" class="btn btn-success dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="true">';c+='<span class="fa fa-user"></span> '+a.attributes.username+' <span class="caret"></span></button>',c+='<ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="signedinDropdown">',c+='<li><a id="profile" href="#">Profile</a></li>',c+='<li><a id="signout" href="http://www.revisit.cc/logout/">Sign Out</a></li>',c+="</ul>",$("div.dropdown").html(c),$(".dropdown-toggle").dropdown("toggle"),app.showView(app.views.cellarView)}else{a.set(b);var d='<div class="alert alert-danger" role="alert">'+b.errors+"</div>";console.log("Fail!"),$(".form-control").attr("disabled",!1),$("#doSignIn").attr("disabled",!1),$("#doSignUp").attr("disabled",!1),$("#signinupDropdown").attr("disabled",!1),$(".dropdown-menu").attr("disabled",!1),$("#signStatus").css("display","none"),$("#signAlert").html(d)}}})},doSignUp:function(a){a.preventDefault(),console.log("view: #doSignUp clicked"),$("#signStatus").css("display","inline"),$("#signAlert").html(""),$("#signinupDropdown").attr("disabled",!0),$(".dropdown-menu").attr("disabled",!0),$(".form-control").attr("disabled",!0),$("#doSignIn").attr("disabled",!0),$("#doSignUp").attr("disabled",!0),app.signup=new app.Signup,app.signup.save({username:$("#inputUsername").val(),password:$("#inputPassword").val()},{success:function(a,b){if(b.success)console.log("Signed Up!");else{a.set(b);var c='<div class="alert alert-danger" role="alert">'+b.errors+"</div>";console.log("Fail!"),$(".form-control").attr("disabled",!1),$("#doSignIn").attr("disabled",!1),$("#doSignUp").attr("disabled",!1),$("#signinupDropdown").attr("disabled",!1),$(".dropdown-menu").attr("disabled",!1),$("#signStatus").css("display","none"),$("#signAlert").html(c)}}})},processForgot:function(a){a.preventDefault(),console.log("view: #gotoForgot clicked"),$("#public-menu").children().removeClass("active"),app.showView(app.views.forgotView)},processReset:function(a){a.preventDefault(),console.log("view: #gotoReset clicked"),$("#public-menu").children().removeClass("active"),app.showView(app.views.resetView)}}),app.HomeView=Backbone.View.extend({el:"#home",template:_.template(JST["assets/views/home/tmpl-home.html"]()),initialize:function(){console.log("homeView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this}}),app.AboutView=Backbone.View.extend({el:"#about",template:_.template(JST["assets/views/about/tmpl-about.html"]()),initialize:function(){console.log("aboutView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this}}),app.CellarView=Backbone.View.extend({el:"#cellar",template:_.template(JST["assets/views/cellar/tmpl-cellar.html"]()),initialize:function(){console.log("cellarView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this}}),app.MyCellarView=Backbone.View.extend({el:"#cellar",template:_.template(JST["assets/views/cellar/tmpl-mycellar.html"](app.user.attributes)),initialize:function(){console.log("mycellarView loaded."),this.render()},render:function(){return console.dir(app.user.attributes),this.$el.html(this.template()),this}}),app.ForgotView=Backbone.View.extend({el:"#forgot",template:_.template(JST["assets/views/login/forgot/tmpl-forgot.html"]()),events:{"click #doForgot":"doForgot"},initialize:function(){console.log("forgotView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this},doForgot:function(a){a.preventDefault(),console.log("view: #doForgot clicked");var b={};b.email=$("#forgotEmail").val(),$.post("api/v1/login/forgot",b,function(a){console.log("responded:"),console.dir(a);var b="";a.success?(b='<div class="alert alert-success" role="alert">Success! Check your email.</div>',$("#forgotErrors").html(b)):(b='<div class="alert alert-danger" role="alert">'+a.errors+"</div>",$("#forgotErrors").html(b))})}}),app.ResetView=Backbone.View.extend({el:"#reset",template:_.template(JST["assets/views/login/reset/tmpl-reset.html"]()),events:{"click #doReset":"doReset"},initialize:function(){console.log("resetView loaded."),this.render()},render:function(){return this.$el.html(this.template("hello")),this},doReset:function(a){a.preventDefault(),console.log("view: #doReset clicked");var b={};b.password=$("#resetPassword").val(),b.confirm=$("#resetConfirm").val(),$.ajax({url:"api/v1/login/reset/"+app.getUrlParameter("u")+"/"+app.getUrlParameter("t")+"/",data:b,type:"PUT",success:function(a){console.log("response:"),console.dir(a);var b="";a.success?(b='<div class="alert alert-success" role="alert">Success! Move along now. <a href="http://www.revisit.cc">Click here</a> to go back!</div>',$("#resetErrors").html(b)):(b='<div class="alert alert-danger" role="alert">'+a.errors+"</div>",$("#resetErrors").html(b))}})}}),app.ResultsView=Backbone.View.extend({el:"#results-table",initialize:function(){this.collection=new app.RecordCollection(app.mainView.results.data),this.listenTo(this.collection,"reset",this.render),this.render()},render:function(){this.$el.html(this.template());var a=document.createDocumentFragment();this.collection.each(function(b){var c=new app.ResultsRowView({model:b});a.appendChild(c.render().el)},this),$("#results-rows").append(a),0===this.collection.length&&$("#results-rows").append($("#tmpl-results-empty-row").html())}}),app.ResultsRowView=Backbone.View.extend({tagName:"tr",events:{"click .btn-details":"viewDetails"},viewDetails:function(){location.href=this.model.url()},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$el.find(".timeago").each(function(a,b){if(b.innerText){var c=moment(b.innerText);b.innerText=c.from(),b.getAttribute("data-age")&&(b.innerText=b.innerText.replace("ago","old"))}}),this}}),app.FilterView=Backbone.View.extend({el:"#filters",events:{"submit form":"preventSubmit",'keypress input[type="text"]':"filterOnEnter","change select":"filter"},initialize:function(){this.model=new app.Filter(app.mainView.results.filters),this.listenTo(this.model,"change",this.render),this.render()},render:function(){this.$el.html(this.template(this.model.attributes));for(var a in this.model.attributes)this.model.attributes.hasOwnProperty(a)&&this.$el.find('[name="'+a+'"]').val(this.model.attributes[a])},preventSubmit:function(a){a.preventDefault()},filterOnEnter:function(a){13===a.keyCode&&this.filter()},filter:function(){var a=$("#filters form").serialize();Backbone.history.navigate("q/"+a,{trigger:!0})}}),app.PagingView=Backbone.View.extend({el:"#results-paging",events:{"click .btn-page":"goToPage"},initialize:function(){this.model=new app.Paging({pages:app.mainView.results.pages,items:app.mainView.results.items}),this.listenTo(this.model,"change",this.render),this.render()},render:function(){this.model.get("pages").total>1?(this.$el.html(this.template(this.model.attributes)),this.model.get("pages").hasPrev||this.$el.find(".btn-prev").attr("disabled","disabled"),this.model.get("pages").hasNext||this.$el.find(".btn-next").attr("disabled","disabled")):this.$el.empty()},goToPage:function(a){var b=$("#filters form").serialize()+"&page="+$(a.target).data("page");Backbone.history.navigate("q/"+b,{trigger:!0}),$("body").scrollTop(0)}}),window.onload=function(){console.log("app loading..."),app.firstLoad=!0,app.views={},app.views.headerView=new app.HeaderView,app.views.homeView=new app.HomeView,app.views.current=app.views.homeView,app.views.aboutView=new app.AboutView,app.views.cellarView=new app.CellarView,app.views.forgotView=new app.ForgotView,app.views.resetView=new app.ResetView,console.log("app loaded!"),console.log(app.getUrlParameter("u")),console.log(app.getUrlParameter("t")),"undefined"!=typeof app.getUrlParameter("u")&&"undefined"!=typeof app.getUrlParameter("t")&&app.showView(app.views.resetView)}}();